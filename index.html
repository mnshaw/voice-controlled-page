
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<title>Example of Speech Recognition</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script>

var potentialcommand = "";

$(document).ready(function() {
  try {
    var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    var recognition = new SpeechRecognition();
    console.log("recognition exists");
  }
  catch(e) {
    console.log("recognition doesn't exist");
    // alert("Voice recognition is not supported");
    alert(e);
    console.error(e);
    $('.no-browser-support').show();
    $('.app').hide();
  }

  var command = "";


  recognition.onstart = function() { 
    console.log("onstart");
    // console.log('Voice recognition activated. Try speaking into the microphone.');
  }

  recognition.onspeechend = function() {
    console.log("onspeechend");
    
    command = "";
    // console.log('You were quiet for a while so voice recognition turned itself off.');
  }

  recognition.onerror = function(event) {
    console.log("onerror")
    alert(event.error);
    if(event.error == 'no-speech') {
      console.log('No speech was detected. Try again.');  
    };
  }

  function simulateClick(element) {
    if (!element) return;
    var dispatchEvent = function (elt, name) {
      var clickEvent = document.createEvent('MouseEvents');
      clickEvent.initEvent(name, true, true);
      elt.dispatchEvent(clickEvent);
    };

    dispatchEvent(element, 'mouseover');
    dispatchEvent(element, 'mousedown');
    dispatchEvent(element, 'click');
    dispatchEvent(element, 'mouseup');
  };

  var istext = false;


  $("#commandbutton").click(function() {
    recognition.start();

    recognition.onresult = function(event) {
      console.log("onresult");

      var current = event.resultIndex;

      // Get a transcript of what was said.
      var transcript = event.results[current][0].transcript;
      var mobileRepeatBug = (current == 1 && transcript == event.results[0][0].transcript);

      if(!mobileRepeatBug) {
        command += transcript;
      }
      console.log(command);

      if (command != "") {
        potentialcommand = command;
        $("#command").text(potentialcommand);
      } 

      console.log("potentialcommand");
      console.log(potentialcommand);

      var re = /^(click|scroll|enter)\s(.*)/i;
      var result = re.exec(potentialcommand);

      if (result) {
        var verb = result[1];
        var arg = result[2]

        console.log("verb: " + verb + ", args: " + arg)

        switch(verb) {
          case "click":
            // what do we do if click?
            console.log("handling click")

            //console.log($("*:contains('" + arg + "')"));

            var stringpieces = arg.split(/\s/);
            console.log("string pieces");
            console.log(stringpieces);

            $("a,input,button").each(function() {
              var element = $(this)[0];
              console.log("element: ", element);
              if (element.attr('id') == stringpieces[0]) {
                console.log("match!");

                simulateClick($(this)[0]);

                if($(this)[0].tagName == "INPUT") {
                istext = true;
                console.log("This is input");
                  // look for the text in INPUT fields
                } else {
                  istext = false;
                  console.log("this is not input");
                }
              }
              
            })

            break;
          case "scroll":
            // what do we do on scroll?
            console.log("handling scroll`")
            break;
          case "enter":
            // what do we do on enter?
            console.log("handling enter")
            break;
          default:
            console.log("sorry, that is not a recognized command")
        }


      //console.log("Scroll " + result[1]);
      //if(result[1]=="up") {
        // scroll up
      //} else if(result[1]=="down") {
        // scroll down
      //}

      }

    };


  })
});
</script>

</head>
  <body>
    Command is:
    <p id="command"></p>
    <p>
      <input type="button" value="Click to say command" id="commandbutton">
    </p>
    <input type="text" id="entry">

    <p>
    <input type="button" id="cat" value="cat"><br>
    <a href="google.com" id="Google">Google</a><br>
    <a href="cmu.edu" id="CMU">CMU</a><br>

  </body>
</html>